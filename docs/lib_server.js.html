<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>lib/server.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Tutorials</li><li class="nav-item"><a href="tutorial-Cluster and threads.html">Cluster and threads</a></li><li class="nav-item"><a href="tutorial-Controllers.html">Controllers</a></li><li class="nav-item"><a href="tutorial-Your first service.html">Your first service</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Application.html">Application</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#_masterReceive">_masterReceive</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#_workerReceive">_workerReceive</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#_workerSend">_workerSend</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#getDbConnection">getDbConnection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#getModel">getModel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#getView">getView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#loadControllers">loadControllers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#loadModels">loadModels</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#loadService">loadService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#loadViews">loadViews</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#prepareUri">prepareUri</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#releaseDbConnection">releaseDbConnection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#run">run</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#run404">run404</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#runError">runError</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Application.html#setDefaultService">setDefaultService</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="BaseController.html">BaseController</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="BaseController.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="BaseController.html#loadModel">loadModel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="BaseController.html#posHandle">posHandle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="BaseController.html#preHandle">preHandle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="BaseController.html#renderView">renderView</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="BaseModel.html">BaseModel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="BaseModel.html#.instanceMode">instanceMode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="BaseModel.html#init">init</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Error.html">Error</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Error.html#error404">error404</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Home.html">Home</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-log.html">log</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log.html#~accessLog">accessLog</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log.html#~customLog">customLog</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-log.html#~databaseLog">databaseLog</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-mvc.html">mvc</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-server.html">server</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-server.html#~setApplication">setApplication</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-util.html">util</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-util.html#~customLog">customLog</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-util.html#~optionalRequire">optionalRequire</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/server.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const mvc = require('@kldit/mvc');
const fs = require('fs');
module.exports.mvc = mvc;
let cluster = null;

const CLUSTER_BOOL = Boolean.parse(process.env.CLUSTER);

if(CLUSTER_BOOL)
{
	cluster = require('cluster');
}

/**
 * @module server
 */
if(CLUSTER_BOOL &amp;&amp; cluster.isMaster)
{
	/**
	 * Define the target Aplication to be "linked" to the koa server.
	 * @function setApplication
	 * @param {Application} theApp - The application object to be set.
	 */
	module.exports.setApplication = function (theApp)
	{
		// theApp.loadServices(true);

		const numCPUs = require('os').cpus().length;
		// Fork workers.
		for(var i = 0; i &lt; numCPUs; i++)
		{
			const worker = cluster.fork();
			// worker.send(`Hello worker ${worker.id}, I am your master!`)
			worker.on('message', async (msg) =>
			{
				worker.send(await theApp._masterReceive(worker, msg));
			});
		}

		cluster.on('exit', (worker, code, signal) =>
		{
			console.log(`Worker ${worker.process.pid} died`);
			console.log('Starting a new worker');
			cluster.fork();
		});
	};
}
else
{
	(function ()
	{
		let setApplication = function (theApp)
		{
			const compress = require('koa-compress');
			const session = require('koa-session');
			const koaBody = require('koa-body');
			const Koa = require('koa');
			const app = new Koa();
			const log = require('./log');
			const path = require('path');

			theApp.init(app);

			const server = app.listen(3000);

			// SET APP ADDRESS
			var HOSTNAME, PATH_NAME;
			if(process.env.HOSTNAMES != '')
			{
				HOSTNAME = process.env.HOSTNAMES;
				PATH_NAME = process.env.PATH_NAMES;
				process.env.HOME = "https://" + HOSTNAME + PATH_NAME;
			}
			else
			{
				HOSTNAME = process.env.HOSTNAME;
				PATH_NAME = process.env.PATH_NAME;
				process.env.HOME = "http://" + HOSTNAME + ":" + process.env.PORT + PATH_NAME;
			}

			process.env.STORAGE_PATH = path.dirname(require.main.filename) + "/" + process.env.STORAGE;

			// Session
			app.keys = [process.env.SESSION_KEY];
			app.use(session(app));

			// POST Data
			app.use(koaBody({ multipart: true }));

			app.use(async function (ctx, next)
			{
				console.log(ctx.request.path, ctx.request.body);
				console.log("\n");
				await next();
			});

			app.use(compress(
			{
				filter: function (content_type)
				{
					return /text/i.test(content_type)
				},
				threshold: 2048,
				flush: require('zlib').Z_SYNC_FLUSH
			}));

			app.use(async (ctx, next) =>
			{
				// Check url is right
				const requestUri = ctx.request.url;

				// TODO: When using SSL, redirect 80 -> 443
				/*if( 'https://'.$_SERVER['HTTP_HOST'].'/' != BASE_PATH || $_SERVER['SERVER_PORT'] != 443 )
				{
					header( 'Location:'.BASE_PATH.substr( $request_uri, 1 ) );
					exit();
				}*/

				if(ctx.hostname != HOSTNAME)
				{
					const PORT = server.address().port;
					var redirect = (PORT == 443 ? "https://" : "http://") +
						HOSTNAME + (PORT != 80 &amp;&amp; PORT != 443 ? ":" + PORT : "") +
						ctx.url;

					ctx.redirect(redirect);
				}
				else
				{
					theApp.prepareUri(ctx);

					await next();
				}
			});

			if(CLUSTER_BOOL)
			{
				//theApp.loadServices(false);

				cluster.worker.on('message', (msg) =>
				{
					theApp._workerReceive(msg);
				});
			}
			else
			{
				// theApp.loadServices(true);
			}

			const getDbConnection = async function ()
			{
				if(!this._db)
				{
					this._db = await theApp.getDbConnection();
				}

				return this._db;
			}

			app.use(async (ctx, next) =>
			{
				try
				{
					await (new Promise(function (resolve, reject)
					{
						ctx.response.send = resolve;
						ctx.response.reject = reject;
						ctx.db = getDbConnection;

						theApp.run(ctx);
					}));
					//var temp = new Promise();
					//await theApp.run( ctx );
					// console.log( "after" );
				}
				catch (err)
				{
					console.error(err);
				}

				await next();
			});

			app.use(async function (ctx)
			{
				if(ctx._db) await theApp.releaseDbConnection( ctx._db );

				// Save console to logs
				log.accessLog(ctx);
				const used = process.memoryUsage().heapUsed / 1024 / 1024;
				console.log(`The script uses approximately ${Math.round(used * 100) / 100} MB`);
			});

			const used = process.memoryUsage().heapUsed / 1024 / 1024;
			console.log(`Setup ${cluster ? 'cluster ' + cluster.worker.id + ': ' : ''} ${Math.round(used * 100) / 100} MB`);
		};

		module.exports.setApplication = setApplication;
	})();
}

/*
const mysql = require('mysql2');

const pool = mysql.createPool({
	host: 'localhost',
	user: 'root',
	database: 'upcms_site',
	waitForConnections: true,
	connectionLimit: 10,
	queueLimit: 0
});

app.use(async (ctx, next) => {
	await next();
	const rt = ctx.response.get('X-Response-Time');
	console.log(`${ctx.method} ${ctx.url} - ${rt}`);
});

// x-response-time

app.use(async (ctx, next) => {
	const start = Date.now();
	await next();
	const ms = Date.now() - start;
	ctx.set('X-Response-Time', `${ms}ms`);
});

app.use(async ctx => {
	//const conn = await pool.promise().getConnection();
	//const [rows,fields] = await conn.query("SELECT * FROM services");
	ctx.body = ctx.request;	
	//pool.releaseConnection(conn);
});
*/
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Oct 30 2018 19:19:39 GMT-0400 (-04) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
